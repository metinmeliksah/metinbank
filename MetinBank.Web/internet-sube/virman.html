<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetinBank - Virman</title>
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-logo">
                <img src="assets/images/logo.png" alt="MetinBank">
            </div>
            <nav class="header-nav">
                <a href="dashboard.html" class="nav-link">Ana Sayfa</a>
                <a href="hesaplar.html" class="nav-link">HesaplarÄ±m</a>
                <div class="nav-dropdown">
                    <div class="nav-link nav-dropdown-toggle active">Para Transferi</div>
                    <div class="nav-dropdown-menu">
                        <a href="havale.html">Havale</a>
                        <a href="eft.html">EFT</a>
                        <a href="virman.html">Virman</a>
                    </div>
                </div>
                <a href="ekstre.html" class="nav-link">Ekstre</a>
                <a href="kartlar.html" class="nav-link">KartlarÄ±m</a>
                <a href="kredi-basvuru.html" class="nav-link">Kredi BaÅŸvurusu</a>
                <a href="profil.html" class="nav-link">Profil</a>
                <a href="#" class="nav-link" onclick="logout(); return false;">Ã‡Ä±kÄ±ÅŸ</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="transfer-modern-container">
                <div class="transfer-header">
                    <h1>ğŸ’¸ Hesaplar ArasÄ± Virman</h1>
                    <p>Kendi hesaplarÄ±nÄ±z arasÄ±nda anÄ±nda ve Ã¼cretsiz para transferi yapÄ±n</p>
                </div>

                <!-- Progress Steps -->
                <div class="transfer-steps">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <div class="step-label">Kaynak Hesap</div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-label">Hedef Hesap</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-label">Tutar</div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-label">Onay</div>
                    </div>
                </div>

                <!-- Transfer Form -->
                <div class="transfer-form-grid">
                    <div class="transfer-form-main">
                        <!-- Source Account Card -->
                        <div class="account-card">
                            <div class="account-card-header">
                                <div class="account-card-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    ğŸ“¤
                                </div>
                                <div>
                                    <h3>GÃ¶nderen Hesap</h3>
                                    <p>Para Ã§ekilecek hesabÄ±nÄ±zÄ± seÃ§in</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <select class="form-input-modern" id="sourceAccount" onchange="updateSourceBalance()">
                                    <option value="">Hesap seÃ§iniz...</option>
                                </select>
                            </div>
                            <div class="account-preview" id="sourceDetails" style="display: none;">
                                <div class="account-preview-item">
                                    <span class="preview-label">IBAN</span>
                                    <span class="preview-value" id="sourceIBAN">-</span>
                                </div>
                                <div class="account-preview-item">
                                    <span class="preview-label">KullanÄ±labilir Bakiye</span>
                                    <span class="preview-value balance-highlight" id="sourceBalance">0,00 TL</span>
                                </div>
                            </div>
                        </div>

                        <!-- Swap Icon -->
                        <div style="text-align: center; margin: var(--spacing-lg) 0;">
                            <div style="display: inline-flex; align-items: center; justify-content: center; width: 48px; height: 48px; 
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; 
                                color: white; font-size: 24px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                                â‡…
                            </div>
                        </div>

                        <!-- Destination Account Card -->
                        <div class="account-card">
                            <div class="account-card-header">
                                <div class="account-card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    ğŸ“¥
                                </div>
                                <div>
                                    <h3>AlÄ±cÄ± Hesap</h3>
                                    <p>Para yatÄ±rÄ±lacak hesabÄ±nÄ±zÄ± seÃ§in</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <select class="form-input-modern" id="destAccount" onchange="updateDestBalance()">
                                    <option value="">Hesap seÃ§iniz...</option>
                                </select>
                            </div>
                            <div class="account-preview" id="destDetails" style="display: none;">
                                <div class="account-preview-item">
                                    <span class="preview-label">IBAN</span>
                                    <span class="preview-value" id="destIBAN">-</span>
                                </div>
                                <div class="account-preview-item">
                                    <span class="preview-label">Mevcut Bakiye</span>
                                    <span class="preview-value" id="destBalance">0,00 TL</span>
                                </div>
                            </div>
                        </div>

                        <!-- Amount Section -->
                        <div class="form-section">
                            <label class="form-label-modern">ğŸ’° Transfer TutarÄ±</label>
                            <div class="amount-input-wrapper">
                                <input type="number" class="form-input-modern amount-input" id="amount" 
                                    placeholder="0,00" step="0.01" min="1" oninput="updateTotal()">
                                <span class="amount-currency">TL</span>
                            </div>
                            <div class="quick-amount-buttons">
                                <button class="quick-amount-btn" onclick="setAmount(100)">100 TL</button>
                                <button class="quick-amount-btn" onclick="setAmount(500)">500 TL</button>
                                <button class="quick-amount-btn" onclick="setAmount(1000)">1.000 TL</button>
                                <button class="quick-amount-btn" onclick="setAmount(5000)">5.000 TL</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label-modern">ğŸ“ AÃ§Ä±klama (Ä°steÄŸe BaÄŸlÄ±)</label>
                            <input type="text" class="form-input-modern" id="description"
                                placeholder="Ã–rn: Kira Ã¶demesi, Birikim aktarÄ±mÄ±..." maxlength="200">
                        </div>
                    </div>

                    <!-- Transfer Summary -->
                    <div class="transfer-summary-modern">
                        <h3>ğŸ“‹ Ä°ÅŸlem Ã–zeti</h3>
                        <div class="summary-card">
                            <div class="summary-item">
                                <span class="summary-icon">ğŸ“¤</span>
                                <div class="summary-content">
                                    <div class="summary-label">GÃ¶nderen</div>
                                    <div class="summary-value" id="summaryFrom">Hesap seÃ§iniz</div>
                                </div>
                            </div>
                            <div class="summary-divider"></div>
                            <div class="summary-item">
                                <span class="summary-icon">ğŸ“¥</span>
                                <div class="summary-content">
                                    <div class="summary-label">AlÄ±cÄ±</div>
                                    <div class="summary-value" id="summaryTo">Hesap seÃ§iniz</div>
                                </div>
                            </div>
                            <div class="summary-divider"></div>
                            <div class="summary-item">
                                <span class="summary-icon">ğŸ’µ</span>
                                <div class="summary-content">
                                    <div class="summary-label">Transfer TutarÄ±</div>
                                    <div class="summary-value" id="summaryAmount">0,00 TL</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <span class="summary-icon">ğŸ</span>
                                <div class="summary-content">
                                    <div class="summary-label">Ä°ÅŸlem Ãœcreti</div>
                                    <div class="summary-value" style="color: var(--success);">Ãœcretsiz</div>
                                </div>
                            </div>
                        </div>

                        <div class="summary-total">
                            <span>Toplam</span>
                            <span id="summaryTotal" class="total-amount">0,00 TL</span>
                        </div>

                        <button class="btn-modern btn-primary-modern" onclick="processTransfer()">
                            <span>âœ“</span> Virman Ä°ÅŸlemini GerÃ§ekleÅŸtir
                        </button>

                        <div class="info-box" style="margin-top: var(--spacing-md);">
                            <strong>â„¹ï¸ Bilgi:</strong> Hesaplar arasÄ± virman iÅŸlemleri anÄ±nda ve Ã¼cretsizdir.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        Copyright Â© 2026 MetinBank - GÃ¼ven, Birikim, Gelecek
    </footer>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/app.js"></script>
    <script>
        checkAuth();

        let accounts = [];
        const VIRMAN_FEE = 0; // Virman iÅŸlemlerinde Ã¼cret yok

        window.addEventListener('DOMContentLoaded', async () => {
            await loadAccounts();
        });

        async function loadAccounts() {
            try {
                const user = getUser();
                const response = await apiGet(`/hesap/musteri/${user.musteriID}`);

                if (response.success && response.data) {
                    accounts = response.data;
                    const sourceSelect = document.getElementById('sourceAccount');
                    const destSelect = document.getElementById('destAccount');

                    accounts.forEach(acc => {
                        const option1 = document.createElement('option');
                        option1.value = acc.hesapID;
                        option1.textContent = `${acc.hesapTipi} ${acc.hesapCinsi} - ${formatIBAN(acc.iban)}`;
                        option1.dataset.iban = acc.iban;
                        option1.dataset.balance = acc.kullanilabilirBakiye;
                        option1.dataset.type = acc.hesapTipi;
                        sourceSelect.appendChild(option1);

                        const option2 = option1.cloneNode(true);
                        destSelect.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        function updateSourceBalance() {
            const select = document.getElementById('sourceAccount');
            const option = select.options[select.selectedIndex];

            if (select.value) {
                document.getElementById('sourceDetails').style.display = 'block';
                document.getElementById('sourceIBAN').textContent = formatIBAN(option.dataset.iban);
                document.getElementById('sourceBalance').textContent =
                    formatCurrency(parseFloat(option.dataset.balance), option.dataset.type);
                document.getElementById('summaryFrom').textContent = formatIBAN(option.dataset.iban);
                updateStep(1);
            } else {
                document.getElementById('sourceDetails').style.display = 'none';
                document.getElementById('summaryFrom').textContent = 'Hesap seÃ§iniz';
            }
        }

        function updateDestBalance() {
            const select = document.getElementById('destAccount');
            const sourceSelect = document.getElementById('sourceAccount');
            
            // AynÄ± hesap kontrolÃ¼
            if (select.value && select.value === sourceSelect.value) {
                alert('Kaynak ve hedef hesap aynÄ± olamaz!');
                select.value = '';
                return;
            }

            const option = select.options[select.selectedIndex];

            if (select.value) {
                document.getElementById('destDetails').style.display = 'block';
                document.getElementById('destIBAN').textContent = formatIBAN(option.dataset.iban);
                const account = accounts.find(acc => acc.hesapID == select.value);
                document.getElementById('destBalance').textContent =
                    formatCurrency(parseFloat(account.bakiye), account.hesapTipi);
                document.getElementById('summaryTo').textContent = formatIBAN(option.dataset.iban);
                updateStep(2);
            } else {
                document.getElementById('destDetails').style.display = 'none';
                document.getElementById('summaryTo').textContent = 'Hesap seÃ§iniz';
            }
        }

        function updateAmount() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            calculateFee(amount);
            document.getElementById('summaryAmount').textContent = formatCurrency(amount, 'TL');
            
            if (amount > 0) {
                document.getElementById('summaryCard').style.display = 'block';
                updateStep(3);
            }
        }

        function updateStep(step) {
            document.querySelectorAll('.step').forEach((el, idx) => {
                if (idx < step) {
                    el.classList.add('active');
                }
            });
        }

        function setAmount(value) {
            document.getElementById('amount').value = value;
            updateTotal();
            updateStep(3);
        }

        function updateTotal() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            document.getElementById('summaryAmount').textContent = formatCurrency(amount, 'TL');
            document.getElementById('summaryTotal').textContent = formatCurrency(amount, 'TL');
            
            if (amount > 0) {
                updateStep(3);
            }
        }

        document.getElementById('amount').addEventListener('input', updateTotal);

        async function processTransfer() {
            const sourceID = document.getElementById('sourceAccount').value;
            const destID = document.getElementById('destAccount').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;

            // Validation
            if (!sourceID) {
                alert('LÃ¼tfen kaynak hesap seÃ§iniz.');
                return;
            }

            if (!destID) {
                alert('LÃ¼tfen hedef hesap seÃ§iniz.');
                return;
            }

            if (sourceID === destID) {
                alert('Kaynak ve hedef hesap aynÄ± olamaz.');
                return;
            }

            if (!amount || amount <= 0) {
                alert('LÃ¼tfen geÃ§erli bir tutar giriniz.');
                return;
            }

            const sourceAccount = accounts.find(acc => acc.hesapID == sourceID);
            const destAccount = accounts.find(acc => acc.hesapID == destID);

            if (amount > sourceAccount.kullanilabilirBakiye) {
                alert(`Yetersiz bakiye!\n\nGÃ¶nderilecek: ${formatCurrency(amount, 'TL')}\nMevcut Bakiye: ${formatCurrency(sourceAccount.kullanilabilirBakiye, 'TL')}`);
                return;
            }

            if (!confirm(`Virman OnayÄ±\n\nGÃ¶nderen: ${formatIBAN(sourceAccount.iban)}\nAlÄ±cÄ±: ${formatIBAN(destAccount.iban)}\nTutar: ${formatCurrency(amount, 'TL')}\nÃœcret: Ãœcretsiz\n\nOnaylÄ±yor musunuz?`)) {
                return;
            }

            try {
                const response = await apiPost('/islem/virman', {
                    kaynakHesapID: parseInt(sourceID),
                    hedefHesapID: parseInt(destID),
                    tutar: amount,
                    aciklama: description || 'Hesaplar ArasÄ± Virman',
                    paraBirimi: 'TL'
                });

                if (response.success) {
                    alert('Virman iÅŸleminiz baÅŸarÄ±yla gerÃ§ekleÅŸtirildi!\n\nÄ°ÅŸlem numaranÄ±z: ' + (response.data?.islemID || 'N/A'));
                    window.location.href = 'dashboard.html';
                } else {
                    alert('Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + (response.message || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error('Transfer error:', error);
                alert('Ä°ÅŸlem sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message);
            }
        }
    </script>
</body>

</html>