<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetinBank - Virman</title>
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-logo">
                <img src="assets/images/logo.png" alt="MetinBank">
            </div>
            <nav class="header-nav">
                <a href="dashboard.html" class="nav-link">Ana Sayfa</a>
                <a href="hesaplar.html" class="nav-link">Hesaplarım</a>
                <div class="nav-dropdown">
                    <div class="nav-link nav-dropdown-toggle active">Para Transferi</div>
                    <div class="nav-dropdown-menu">
                        <a href="havale.html">Havale</a>
                        <a href="eft.html">EFT</a>
                        <a href="virman.html">Virman</a>
                    </div>
                </div>
                <a href="ekstre.html" class="nav-link">Ekstre</a>
                <a href="kartlar.html" class="nav-link">Kartlarım</a>
                <a href="kredi-basvuru.html" class="nav-link">Kredi Başvurusu</a>
                <a href="profil.html" class="nav-link">Profil</a>
                <a href="#" class="nav-link" onclick="logout(); return false;">Çıkış</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="transfer-container">
                <h1 style="margin-bottom: var(--spacing-xl);">Virman İşlemi</h1>
                <p style="color: var(--gray-600); margin-bottom: var(--spacing-xl);">
                    Hesaplarınız arasında para transferi yapın. Virman işlemlerinde ücret alınmaz.
                </p>

                <!-- Two Column Layout -->
                <div class="transfer-grid">
                    <!-- Left Panel - Source -->
                    <div class="transfer-panel">
                        <div class="panel-header">
                            <div class="panel-icon ">↗️</div>
                            <div class="panel-title">Kaynak Hesap</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Hesap Seçin</label>
                            <select class="form-select" id="sourceAccount" onchange="updateSourceBalance()">
                                <option value="">Hesap seçiniz...</option>
                            </select>
                            <div class="selected-account" id="sourceDetails" style="display: none;">
                                <div id="sourceIBAN"></div>
                                <div class="account-balance">
                                    <span class="balance-label">Kullanılabilir Bakiye:</span>
                                    <span class="balance-amount" id="sourceBalance">0,00 TL</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Destination -->
                    <div class="transfer-panel">
                        <div class="panel-header">
                            <div class="panel-icon">↘️</div>
                            <div class="panel-title">Hedef Hesap</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Hesap Seçin</label>
                            <select class="form-select" id="destAccount" onchange="updateDestBalance()">
                                <option value="">Hesap seçiniz...</option>
                            </select>
                            <div class="selected-account" id="destDetails" style="display: none;">
                                <div id="destIBAN"></div>
                                <div class="account-balance">
                                    <span class="balance-label">Mevcut Bakiye:</span>
                                    <span class="balance-amount" id="destBalance">0,00 TL</span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tutar</label>
                            <input type="number" class="form-input" id="amount" placeholder="0,00" step="0.01" min="1">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Açıklama</label>
                            <input type="text" class="form-input" id="description"
                                placeholder="İşlem açıklaması (isteğe bağlı)" maxlength="200">
                        </div>
                    </div>
                </div>

                <!-- Transfer Summary -->
                <div class="transfer-summary">
                    <h3 style="margin-bottom: var(--spacing-md);">İşlem Özeti</h3>
                    <div class="summary-row">
                        <span>Kaynak:</span>
                        <span id="summaryFrom">-</span>
                    </div>
                    <div class="summary-row">
                        <span>Hedef:</span>
                        <span id="summaryTo">-</span>
                    </div>
                    <div class="summary-row">
                        <span>İşlem Ücreti:</span>
                        <span>0,00 TL</span>
                    </div>
                    <div class="summary-row">
                        <span>Toplam:</span>
                        <span id="summaryTotal">0,00 TL</span>
                    </div>
                    <button class="btn btn-success btn-lg" style="width: 100%; margin-top: var(--spacing-md);"
                        onclick="processTransfer()">
                        Virman Yap
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        Copyright © 2026 MetinBank - Güven, Birikim, Gelecek
    </footer>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/app.js"></script>
    <script>
        checkAuth();

        let accounts = [];

        window.addEventListener('DOMContentLoaded', async () => {
            await loadAccounts();
        });

        async function loadAccounts() {
            try {
                const user = getUser();
                const response = await apiGet(`/hesap/musteri/${user.musteriID}`);

                if (response.success && response.data) {
                    accounts = response.data;
                    const sourceSelect = document.getElementById('sourceAccount');
                    const destSelect = document.getElementById('destAccount');

                    accounts.forEach(acc => {
                        const option1 = document.createElement('option');
                        option1.value = acc.hesapID;
                        option1.textContent = `${acc.hesapTipi} ${acc.hesapCinsi} - ${formatIBAN(acc.iban)}`;
                        option1.dataset.iban = acc.iban;
                        option1.dataset.balance = acc.kullanilabilirBakiye;
                        option1.dataset.type = acc.hesapTipi;
                        sourceSelect.appendChild(option1);

                        const option2 = option1.cloneNode(true);
                        destSelect.appendChild(option2);
                    });
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        function updateSourceBalance() {
            const select = document.getElementById('sourceAccount');
            const option = select.options[select.selectedIndex];

            if (select.value) {
                document.getElementById('sourceDetails').style.display = 'block';
                document.getElementById('sourceIBAN').textContent = formatIBAN(option.dataset.iban);
                document.getElementById('sourceBalance').textContent =
                    formatCurrency(parseFloat(option.dataset.balance), option.dataset.type);
                document.getElementById('summaryFrom').textContent = formatIBAN(option.dataset.iban);
            } else {
                document.getElementById('sourceDetails').style.display = 'none';
                document.getElementById('summaryFrom').textContent = '-';
            }
        }

        function updateDestBalance() {
            const select = document.getElementById('destAccount');
            const option = select.options[select.selectedIndex];

            if (select.value) {
                document.getElementById('destDetails').style.display = 'block';
                document.getElementById('destIBAN').textContent = formatIBAN(option.dataset.iban);
                const account = accounts.find(acc => acc.hesapID == select.value);
                document.getElementById('destBalance').textContent =
                    formatCurrency(parseFloat(account.bakiye), account.hesapTipi);
                document.getElementById('summaryTo').textContent = formatIBAN(option.dataset.iban);
            } else {
                document.getElementById('destDetails').style.display = 'none';
                document.getElementById('summaryTo').textContent = '-';
            }
        }

        let currentFee = 0;

        async function calculateFee() {
            const amount = parseFloat(document.getElementById('amount').value);
            if (!amount || amount <= 0) {
                currentFee = 0;
                return;
            }

            try {
                const response = await apiGet(`/islemUcreti/hesapla?islemTipi=Virman&islemKanali=Internet&tutar=${amount}`);
                if (response.success && response.data) {
                    currentFee = response.data.ucret;
                }
            } catch (error) {
                console.error('Fee calculation error:', error);
                currentFee = 0;
            }
        }

        function updateTotal() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const feeDisplay = document.querySelector('.summary-row:nth-child(3) span:last-child');
            if (feeDisplay) {
                feeDisplay.textContent = formatCurrency(currentFee, 'TL');
            }
            document.getElementById('summaryTotal').textContent = formatCurrency(amount + currentFee, 'TL');
        }

        document.getElementById('amount').addEventListener('input', async () => {
            await calculateFee();
            updateTotal();
        });

        async function processTransfer() {
            const sourceID = document.getElementById('sourceAccount').value;
            const destID = document.getElementById('destAccount').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;

            // Validation
            if (!sourceID) {
                alert('Lütfen kaynak hesap seçiniz.');
                return;
            }

            if (!destID) {
                alert('Lütfen hedef hesap seçiniz.');
                return;
            }

            if (sourceID === destID) {
                alert('Kaynak ve hedef hesap aynı olamaz!');
                return;
            }

            if (!amount || amount <= 0) {
                alert('Lütfen geçerli bir tutar giriniz.');
                return;
            }

            const sourceAccount = accounts.find(acc => acc.hesapID == sourceID);

            if (amount > sourceAccount.kullanilabilirBakiye) {
                alert('Yetersiz bakiye!');
                return;
            }

            if (!confirm(`${formatCurrency(amount, 'TL')} tutarında virman yapmak istediğinizden emin misiniz?`)) {
                return;
            }

            try {
                const response = await apiPost('/islem/virman', {
                    kaynakHesapID: parseInt(sourceID),
                    hedefHesapID: parseInt(destID),
                    tutar: amount,
                    aciklama: description || 'Virman',
                    paraBirimi: sourceAccount.hesapTipi
                });

                if (response.success) {
                    alert('✓ Virman işleminiz başarıyla gerçekleştirildi!');
                    window.location.href = 'dashboard.html';
                } else {
                    alert('Hata: ' + (response.message || 'İşlem başarısız.'));
                }
            } catch (error) {
                console.error('Transfer error:', error);
                alert('İşlem sırasında hata oluştu.');
            }
        }
    </script>
</body>

</html>