<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetinBank - Havale</title>
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-logo">
                <img src="assets/images/logo.png" alt="MetinBank">
            </div>
            <nav class="header-nav">
                <a href="dashboard.html" class="nav-link">Ana Sayfa</a>
                <a href="hesaplar.html" class="nav-link">Hesaplarƒ±m</a>
                <div class="nav-dropdown">
                    <div class="nav-link nav-dropdown-toggle active">Para Transferi</div>
                    <div class="nav-dropdown-menu">
                        <a href="havale.html">Havale</a>
                        <a href="eft.html">EFT</a>
                        <a href="virman.html">Virman</a>
                    </div>
                </div>
                <a href="ekstre.html" class="nav-link">Ekstre</a>
                <a href="kartlar.html" class="nav-link">Kartlarƒ±m</a>
                <a href="kredi-basvuru.html" class="nav-link">Kredi Ba≈üvurusu</a>
                <a href="profil.html" class="nav-link">Profil</a>
                <a href="#" class="nav-link" onclick="logout(); return false;">√áƒ±kƒ±≈ü</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="transfer-container">
                <h1 style="margin-bottom: var(--spacing-xl);">Havale ƒ∞≈ülemi</h1>

                <!-- Two Column Layout -->
                <div class="transfer-grid">
                    <!-- Left Panel - Sender -->
                    <div class="transfer-panel">
                        <div class="panel-header">
                            <div class="panel-icon">üì§</div>
                            <div class="panel-title">G√∂nderen Hesap</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Hesap Se√ßin</label>
                            <select class="form-select" id="senderAccount" onchange="updateSenderBalance()">
                                <option value="">Hesap se√ßiniz...</option>
                            </select>
                            <div class="selected-account" id="senderDetails" style="display: none;">
                                <div id="senderIBAN"></div>
                                <div class="account-balance">
                                    <span class="balance-label">Kullanƒ±labilir Bakiye:</span>
                                    <span class="balance-amount" id="senderBalance">0,00 TL</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Recipient -->
                    <div class="transfer-panel">
                        <div class="panel-header">
                            <div class="panel-icon">üì•</div>
                            <div class="panel-title">Alƒ±cƒ± Bilgileri</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Alƒ±cƒ± IBAN</label>
                            <div class="iban-lookup">
                                <input type="text" class="form-input" id="recipientIBAN"
                                    placeholder="TR00 0000 0000 0000 0000 0000 00" maxlength="32"
                                    oninput="formatIBANInput(this)">
                                <button class="btn btn-primary" onclick="lookupIBAN()">üîç</button>
                            </div>
                            <div class="recipient-name" id="recipientName" style="display: none;"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tutar (TL)</label>
                            <input type="number" class="form-input" id="amount" placeholder="0,00" step="0.01" min="1">
                        </div>

                        <div class="form-group">
                            <label class="form-label">A√ßƒ±klama</label>
                            <input type="text" class="form-input" id="description"
                                placeholder="ƒ∞≈ülem a√ßƒ±klamasƒ± (isteƒüe baƒülƒ±)" maxlength="200">
                        </div>
                    </div>
                </div>

                <!-- Transfer Summary -->
                <div class="transfer-summary">
                    <h3 style="margin-bottom: var(--spacing-md);">ƒ∞≈ülem √ñzeti</h3>
                    <div class="summary-row">
                        <span>G√∂nderen:</span>
                        <span id="summaryFrom">-</span>
                    </div>
                    <div class="summary-row">
                        <span>Alƒ±cƒ±:</span>
                        <span id="summaryTo">-</span>
                    </div>
                    <div class="summary-row">
                        <span>ƒ∞≈ülem √úcreti:</span>
                        <span id="feeAmount">0,00 TL</span>
                    </div>
                    <div class="summary-row">
                        <span>Toplam:</span>
                        <span id="summaryTotal">0,00 TL</span>
                    </div>
                    <button class="btn btn-success btn-lg" style="width: 100%; margin-top: var(--spacing-md);"
                        onclick="processTransfer()">
                        Havale G√∂nder
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        Copyright ¬© 2026 MetinBank - G√ºven, Birikim, Gelecek
    </footer>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/app.js"></script>
    <script>
        checkAuth();

        let accounts = [];
        let recipientData = null;

        window.addEventListener('DOMContentLoaded', async () => {
            await loadAccounts();
        });

        async function loadAccounts() {
            try {
                const user = getUser();
                const response = await apiGet(`/hesap/musteri/${user.musteriID}`);

                if (response.success && response.data) {
                    accounts = response.data;
                    const select = document.getElementById('senderAccount');

                    accounts.forEach(acc => {
                        const option = document.createElement('option');
                        option.value = acc.hesapID;
                        option.textContent = `${acc.hesapTipi} ${acc.hesapCinsi} - ${formatIBAN(acc.iban)}`;
                        option.dataset.iban = acc.iban;
                        option.dataset.balance = acc.kullanilabilirBakiye;
                        option.dataset.type = acc.hesapTipi;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        function updateSenderBalance() {
            const select = document.getElementById('senderAccount');
            const option = select.options[select.selectedIndex];

            if (select.value) {
                document.getElementById('senderDetails').style.display = 'block';
                document.getElementById('senderIBAN').textContent = formatIBAN(option.dataset.iban);
                document.getElementById('senderBalance').textContent =
                    formatCurrency(parseFloat(option.dataset.balance), option.dataset.type);
                document.getElementById('summaryFrom').textContent = formatIBAN(option.dataset.iban);
            } else {
                document.getElementById('senderDetails').style.display = 'none';
                document.getElementById('summaryFrom').textContent = '-';
            }
            updateTotal();
        }

        function formatIBANInput(input) {
            let value = input.value.replace(/\s/g, '').toUpperCase();
            let formatted = '';
            for (let i = 0; i < value.length; i += 4) {
                if (i > 0) formatted += ' ';
                formatted += value.substring(i, i + 4);
            }
            input.value = formatted;
        }

        async function lookupIBAN() {
            const iban = document.getElementById('recipientIBAN').value.replace(/\s/g, '');

            if (iban.length < 26) {
                alert('L√ºtfen ge√ßerli bir IBAN giriniz.');
                return;
            }

            try {
                const response = await apiPost('/hesap/iban-sorgula', { iban });

                if (response.success && response.data) {
                    recipientData = response.data;
                    const nameDiv = document.getElementById('recipientName');
                    nameDiv.textContent = `‚úì ${response.data.musteriAdi}`;
                    nameDiv.style.display = 'block';
                    document.getElementById('summaryTo').textContent = response.data.musteriAdi;
                } else {
                    alert(response.message || 'IBAN bulunamadƒ±.');
                    recipientData = null;
                }
            } catch (error) {
                console.error('IBAN lookup error:', error);
                alert('IBAN sorgulanƒ±rken hata olu≈ütu.');
            }
        }

        let currentFee = 0;

        async function calculateFee() {
            const amount = parseFloat(document.getElementById('amount').value);
            if (!amount || amount <= 0) {
                currentFee = 0;
                return;
            }

            try {
                const response = await apiGet(`/islemUcreti/hesapla?islemTipi=Havale&islemKanali=Internet&tutar=${amount}`);
                if (response.success && response.data) {
                    currentFee = response.data.ucret;
                }
            } catch (error) {
                console.error('Fee calculation error:', error);
                currentFee = 0;
            }
        }

        function updateTotal() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const feeDisplay = document.querySelector('.summary-row:nth-child(3) span:last-child');
            if (feeDisplay) {
                feeDisplay.textContent = formatCurrency(currentFee, 'TL');
            }
            document.getElementById('summaryTotal').textContent = formatCurrency(amount + currentFee, 'TL');
        }

        document.getElementById('amount').addEventListener('input', async () => {
            await calculateFee();
            updateTotal();
        });

        async function processTransfer() {
            const senderID = document.getElementById('senderAccount').value;
            const recipientIBAN = document.getElementById('recipientIBAN').value.replace(/\s/g, '');
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;

            // Validation
            if (!senderID) {
                alert('L√ºtfen g√∂nderen hesap se√ßiniz.');
                return;
            }

            if (!recipientData) {
                alert('L√ºtfen alƒ±cƒ± IBAN sorgulayƒ±nƒ±z.');
                return;
            }

            if (!amount || amount <= 0) {
                alert('L√ºtfen ge√ßerli bir tutar giriniz.');
                return;
            }

            const senderAccount = accounts.find(acc => acc.hesapID == senderID);
            if (amount > senderAccount.kullanilabilirBakiye) {
                alert('Yetersiz bakiye!');
                return;
            }

            if (!confirm(`${formatCurrency(amount, 'TL')} tutarƒ±nda havale yapmak istediƒüinizden emin misiniz?`)) {
                return;
            }

            try {
                const response = await apiPost('/islem/havale', {
                    kaynakHesapID: parseInt(senderID),
                    hedefIBAN: recipientIBAN,
                    tutar: amount,
                    aciklama: description || 'Havale',
                    paraBirimi: 'TL'
                });

                if (response.success) {
                    alert('‚úì Havale i≈üleminiz ba≈üarƒ±yla ger√ßekle≈ütirildi!');
                    window.location.href = 'dashboard.html';
                } else {
                    alert('Hata: ' + (response.message || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z.'));
                }
            } catch (error) {
                console.error('Transfer error:', error);
                alert('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu.');
            }
        }
    </script>
</body>

</html>