<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetinBank - EFT</title>
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-logo">
                <img src="assets/images/logo.png" alt="MetinBank">
            </div>
            <nav class="header-nav">
                <a href="dashboard.html" class="nav-link">Ana Sayfa</a>
                <a href="hesaplar.html" class="nav-link">HesaplarÄ±m</a>
                <div class="nav-dropdown">
                    <div class="nav-link nav-dropdown-toggle active">Para Transferi</div>
                    <div class="nav-dropdown-menu">
                        <a href="havale.html">Havale</a>
                        <a href="eft.html">EFT</a>
                        <a href="virman.html">Virman</a>
                    </div>
                </div>
                <a href="ekstre.html" class="nav-link">Ekstre</a>
                <a href="kartlar.html" class="nav-link">KartlarÄ±m</a>
                <a href="kredi-basvuru.html" class="nav-link">Kredi BaÅŸvurusu</a>
                <a href="profil.html" class="nav-link">Profil</a>
                <a href="#" class="nav-link" onclick="logout(); return false;">Ã‡Ä±kÄ±ÅŸ</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="transfer-modern-container">
                <!-- Header -->
                <div class="transfer-header">
                    <div class="transfer-header-content">
                        <div class="transfer-icon-large">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M16 8l-4 8-4-4"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="transfer-title">EFT Ä°ÅŸlemi</h1>
                            <p class="transfer-subtitle">DiÄŸer bankalara elektronik fon transferi</p>
                        </div>
                    </div>
                </div>

                <!-- Progress Steps -->
                <div class="transfer-steps">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <div class="step-label">GÃ¶nderen</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-label">Banka</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-label">AlÄ±cÄ±</div>
                    </div>
                    <div class="step-line"></div>
                    <div class="step" id="step4">
                        <div class="step-number">4</div>
                        <div class="step-label">Tutar</div>
                    </div>
                </div>

                <!-- Form Card -->
                <div class="transfer-card">
                    <!-- Sender Section -->
                    <div class="transfer-section">
                        <div class="section-header-modern">
                            <div class="section-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 3h18v18H3zM3 9h18M9 21V9"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="section-title-modern">GÃ¶nderen Hesap</h3>
                                <p class="section-desc">EFT yapacaÄŸÄ±nÄ±z hesabÄ± seÃ§in</p>
                            </div>
                        </div>

                        <div class="form-group-modern">
                            <label class="form-label-modern">
                                <span class="label-text">HesabÄ±nÄ±zÄ± SeÃ§in</span>
                                <span class="label-required">*</span>
                            </label>
                            <select class="form-input-modern" id="senderAccount" onchange="updateSenderBalance()">
                                <option value="">Bir hesap seÃ§in...</option>
                            </select>
                        </div>

                        <div class="account-preview" id="senderDetails" style="display: none;">
                            <div class="account-preview-header">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                    <line x1="1" y1="10" x2="23" y2="10"></line>
                                </svg>
                                <span class="account-preview-label">SeÃ§ili Hesap</span>
                            </div>
                            <div class="account-preview-iban" id="senderIBAN"></div>
                            <div class="account-preview-balance">
                                <span class="balance-label-modern">KullanÄ±labilir Bakiye</span>
                                <span class="balance-value-modern" id="senderBalance">0,00 TL</span>
                            </div>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Bank Selection -->
                    <div class="transfer-section">
                        <div class="section-header-modern">
                            <div class="section-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
                                    <path d="M9 22V12h6v10"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="section-title-modern">AlÄ±cÄ± BankasÄ±</h3>
                                <p class="section-desc">EFT yapÄ±lacak bankayÄ± seÃ§in</p>
                            </div>
                        </div>

                        <div class="form-group-modern">
                            <label class="form-label-modern">
                                <span class="label-text">Banka SeÃ§in</span>
                                <span class="label-required">*</span>
                            </label>
                            <div class="bank-grid" id="bankGrid">
                                <!-- Banks will be loaded here -->
                            </div>
                            <input type="hidden" id="recipientBank">
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Recipient Section -->
                    <div class="transfer-section">
                        <div class="section-header-modern">
                            <div class="section-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                            <div>
                                <h3 class="section-title-modern">AlÄ±cÄ± Bilgileri</h3>
                                <p class="section-desc">IBAN numarasÄ±nÄ± girin</p>
                            </div>
                        </div>

                        <div class="form-group-modern">
                            <label class="form-label-modern">
                                <span class="label-text">AlÄ±cÄ± IBAN</span>
                                <span class="label-required">*</span>
                            </label>
                            <div class="iban-input-wrapper">
                                <input type="text" 
                                       class="form-input-modern iban-input" 
                                       id="recipientIBAN"
                                       placeholder="TR00 0000 0000 0000 0000 0000 00" 
                                       maxlength="32"
                                       oninput="formatIBANInput(this)">
                            </div>
                            <div class="input-hint">AlÄ±cÄ±nÄ±n diÄŸer bankadaki IBAN numarasÄ±</div>
                        </div>

                        <div class="form-group-modern">
                            <label class="form-label-modern">
                                <span class="label-text">AlÄ±cÄ± AdÄ± SoyadÄ±</span>
                                <span class="label-required">*</span>
                            </label>
                            <input type="text" 
                                   class="form-input-modern" 
                                   id="recipientName"
                                   placeholder="Ad Soyad"
                                   maxlength="100">
                            <div class="input-hint">AlÄ±cÄ±nÄ±n tam adÄ±nÄ± yazÄ±n</div>
                        </div>

                        <div class="form-row">
                            <div class="form-group-modern">
                                <label class="form-label-modern">
                                    <span class="label-text">Tutar</span>
                                    <span class="label-required">*</span>
                                </label>
                                <div class="amount-input-wrapper">
                                    <input type="text" 
                                           class="form-input-modern amount-input" 
                                           id="amount" 
                                           placeholder="0,00"
                                           oninput="handleAmountInput(this)">
                                    <span class="amount-currency">TL</span>
                                </div>
                                <div class="quick-amounts">
                                    <button class="quick-amount-btn" onclick="setAmount(100)">100 TL</button>
                                    <button class="quick-amount-btn" onclick="setAmount(500)">500 TL</button>
                                    <button class="quick-amount-btn" onclick="setAmount(1000)">1.000 TL</button>
                                    <button class="quick-amount-btn" onclick="setAmount(5000)">5.000 TL</button>
                                </div>
                            </div>

                            <div class="form-group-modern">
                                <label class="form-label-modern">
                                    <span class="label-text">AÃ§Ä±klama</span>
                                </label>
                                <input type="text" 
                                       class="form-input-modern" 
                                       id="description"
                                       placeholder="Ä°ÅŸlem aÃ§Ä±klamasÄ± (isteÄŸe baÄŸlÄ±)" 
                                       maxlength="200">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Card -->
                <div class="transfer-summary-modern" id="summaryCard" style="display: none;">
                    <div class="summary-header">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                        </svg>
                        <span>Ä°ÅŸlem Ã–zeti</span>
                    </div>
                    <div class="summary-content">
                        <div class="summary-item">
                            <span class="summary-label">GÃ¶nderen</span>
                            <span class="summary-value" id="summaryFrom">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">AlÄ±cÄ± BankasÄ±</span>
                            <span class="summary-value" id="summaryBank">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">AlÄ±cÄ±</span>
                            <span class="summary-value" id="summaryTo">-</span>
                        </div>
                        <div class="summary-divider"></div>
                        <div class="summary-item">
                            <span class="summary-label">Tutar</span>
                            <span class="summary-value" id="summaryAmount">0,00 TL</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">EFT Ãœcreti</span>
                            <span class="summary-value" id="feeAmount">5,00 TL</span>
                        </div>
                        <div class="summary-divider"></div>
                        <div class="summary-item summary-total">
                            <span class="summary-label">Toplam</span>
                            <span class="summary-value" id="summaryTotal">0,00 TL</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="transfer-actions">
                    <button class="btn-modern btn-secondary-modern" onclick="window.history.back()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"></path>
                        </svg>
                        Geri
                    </button>
                    <button class="btn-modern btn-primary-modern" onclick="processTransfer()" id="submitBtn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                        EFT GÃ¶nder
                    </button>
                </div>
            </div>
        </div>
    </main>
                            <label class="form-label">AlÄ±cÄ± AdÄ±</label>
                            <input type="text" class="form-input" id="recipientName" placeholder="AlÄ±cÄ± adÄ± soyadÄ±">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tutar (TL)</label>
                            <input type="number" class="form-input" id="amount" placeholder="0,00" step="0.01" min="1">
                        </div>

                        <div class="form-group">
                            <label class="form-label">AÃ§Ä±klama</label>
                            <input type="text" class="form-input" id="description"
                                placeholder="Ä°ÅŸlem aÃ§Ä±klamasÄ± (isteÄŸe baÄŸlÄ±)" maxlength="200">
                        </div>
                    </div>
                </div>

                <!-- Transfer Summary -->
                <div class="transfer-summary">
                    <h3 style="margin-bottom: var(--spacing-md);">Ä°ÅŸlem Ã–zeti</h3>
                    <div class="summary-row">
                        <span>GÃ¶nderen:</span>
                        <span id="summaryFrom">-</span>
                    </div>
                    <div class="summary-row">
                        <span>AlÄ±cÄ± Banka:</span>
                        <span id="summaryBank">-</span>
                    </div>
                    <div class="summary-row">
                        <span>AlÄ±cÄ±:</span>
                        <span id="summaryTo">-</span>
                    </div>
                    <div class="summary-row">
                        <span>Ä°ÅŸlem Ãœcreti:</span>
                        <span>2,50 TL</span>
                    </div>
                    <div class="summary-row">
                        <span>Toplam:</span>
                        <span id="summaryTotal">0,00 TL</span>
                    </div>
                    <button class="btn btn-warning btn-lg"
                        style="width: 100%; margin-top: var(--spacing-md); color: white;" onclick="processTransfer()">
                        EFT GÃ¶nder
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        Copyright Â© 2026 MetinBank - GÃ¼ven, Birikim, Gelecek
    </footer>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/app.js"></script>
    <script>
        checkAuth();

        let accounts = [];
        let selectedBank = null;
        let currentFee = 2.50;
        let ibanLookupTimeout = null;

        const banks = [
            { code: 'AKBANK', name: 'Akbank', logo: 'ğŸ¦' },
            { code: 'GARANTI', name: 'Garanti BBVA', logo: 'ğŸ¦' },
            { code: 'ISBANK', name: 'Ä°ÅŸ BankasÄ±', logo: 'ğŸ¦' },
            { code: 'YAPI_KREDI', name: 'YapÄ± Kredi', logo: 'ğŸ¦' },
            { code: 'ZIRAAT', name: 'Ziraat BankasÄ±', logo: 'ğŸ¦' },
            { code: 'HALKBANK', name: 'Halk BankasÄ±', logo: 'ğŸ¦' },
            { code: 'VAKIFBANK', name: 'VakÄ±fbank', logo: 'ğŸ¦' },
            { code: 'TEB', name: 'TEB', logo: 'ğŸ¦' },
            { code: 'DENIZBANK', name: 'Denizbank', logo: 'ğŸ¦' },
            { code: 'QNB', name: 'QNB Finansbank', logo: 'ğŸ¦' },
            { code: 'ING', name: 'ING', logo: 'ğŸ¦' },
            { code: 'KUVEYT_TURK', name: 'Kuveyt TÃ¼rk', logo: 'ğŸ¦' }
        ];

        window.addEventListener('DOMContentLoaded', async () => {
            await loadAccounts();
            renderBankGrid();
        });

        function renderBankGrid() {
            const grid = document.getElementById('bankGrid');
            grid.innerHTML = banks.map(bank => `
                <div class="bank-card" onclick="selectBank('${bank.code}', '${bank.name}')">
                    <div class="bank-logo">${bank.logo}</div>
                    <div class="bank-name">${bank.name}</div>
                </div>
            `).join('');
        }

        function selectBank(code, name) {
            selectedBank = { code, name };
            document.querySelectorAll('.bank-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.bank-card').classList.add('selected');
            document.getElementById('summaryBank').textContent = name;
            updateStep(2);
        }

        async function loadAccounts() {
            try {
                const user = getUser();
                const response = await apiGet(`/hesap/musteri/${user.musteriID}`);

                if (response.success && response.data) {
                    accounts = response.data;
                    const select = document.getElementById('senderAccount');

                    accounts.forEach(acc => {
                        const option = document.createElement('option');
                        option.value = acc.hesapID;
                        option.textContent = `${acc.hesapTipi} ${acc.hesapCinsi} - ${formatIBAN(acc.iban)}`;
                        option.dataset.iban = acc.iban;
                        option.dataset.balance = acc.kullanilabilirBakiye;
                        option.dataset.type = acc.hesapTipi;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        function updateSenderBalance() {
            const select = document.getElementById('senderAccount');
            const option = select.options[select.selectedIndex];

            if (select.value) {
                document.getElementById('senderDetails').style.display = 'block';
                document.getElementById('senderIBAN').textContent = formatIBAN(option.dataset.iban);
                document.getElementById('senderBalance').textContent =
                    formatCurrency(parseFloat(option.dataset.balance), option.dataset.type);
                document.getElementById('summaryFrom').textContent = formatIBAN(option.dataset.iban);
                updateStep(1);
            } else {
                document.getElementById('senderDetails').style.display = 'none';
                document.getElementById('summaryFrom').textContent = '-';
            }
        }

        function updateStep(step) {
            document.querySelectorAll('.step').forEach((el, idx) => {
                if (idx < step) {
                    el.classList.add('active');
                }
            });
        }

        async function handleIBANInput(event) {
            const input = event.target;
            let value = input.value.replace(/\s/g, '').toUpperCase();
            
            // Format with spaces
            let formatted = '';
            for (let i = 0; i < value.length && i < 26; i += 4) {
                if (i > 0) formatted += ' ';
                formatted += value.substring(i, i + 4);
            }
            input.value = formatted;

            const recipientInfo = document.getElementById('recipientInfo');
            const lookupStatus = document.getElementById('lookupStatus');

            // Clear previous timeout
            if (ibanLookupTimeout) {
                clearTimeout(ibanLookupTimeout);
            }

            // Hide recipient info while typing
            recipientInfo.style.display = 'none';
            
            const cleanIBAN = value.replace(/\s/g, '');
            
            if (cleanIBAN.length === 26) {
                lookupStatus.textContent = 'Hesap bilgisi alÄ±nÄ±yor...';
                lookupStatus.className = 'lookup-status loading';
                lookupStatus.style.display = 'block';

                // Debounce lookup
                ibanLookupTimeout = setTimeout(async () => {
                    try {
                        const response = await apiGet(`/hesap/iban/${cleanIBAN}`);
                        
                        if (response.success && response.data) {
                            const account = response.data;
                            lookupStatus.style.display = 'none';
                            recipientInfo.style.display = 'flex';
                            
                            const fullName = `${account.musteri.ad} ${account.musteri.soyad}`;
                            document.getElementById('recipientNameDisplay').textContent = fullName;
                            document.getElementById('recipientBankDisplay').textContent = 'MetinBank';
                            document.getElementById('summaryTo').textContent = fullName;
                            
                            updateStep(3);
                        } else {
                            lookupStatus.textContent = 'âš ï¸ Hesap bulunamadÄ±';
                            lookupStatus.className = 'lookup-status error';
                        }
                    } catch (error) {
                        console.error('IBAN lookup error:', error);
                        lookupStatus.textContent = 'âš ï¸ Hesap bilgisi alÄ±namadÄ±';
                        lookupStatus.className = 'lookup-status error';
                    }
                }, 500);
            } else {
                lookupStatus.style.display = 'none';
            }
        }

        function setAmount(value) {
            document.getElementById('amount').value = value;
            updateTotal();
            updateStep(4);
        }

        async function calculateFee() {
            const amount = parseFloat(document.getElementById('amount').value);
            if (!amount || amount <= 0) {
                currentFee = 2.50;
                return;
            }

            try {
                const response = await apiGet(`/islemUcreti/hesapla?islemTipi=EFT&islemKanali=Internet&tutar=${amount}`);
                if (response.success && response.data) {
                    currentFee = response.data.ucret;
                }
            } catch (error) {
                console.error('Fee calculation error:', error);
                currentFee = 2.50;
            }
        }

        function updateTotal() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            calculateFee().then(() => {
                const total = amount + currentFee;
                const feeDisplay = document.querySelector('.summary-row:nth-child(4) span:last-child');
                if (feeDisplay) {
                    feeDisplay.textContent = formatCurrency(currentFee, 'TL');
                }
                document.getElementById('summaryTotal').textContent = formatCurrency(total, 'TL');
            });
        }

        document.getElementById('amount').addEventListener('input', updateTotal);

        async function processTransfer() {
            const senderID = document.getElementById('senderAccount').value;
            const recipientIBAN = document.getElementById('recipientIBAN').value.replace(/\s/g, '');
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;

            // Validation
            if (!senderID) {
                alert('LÃ¼tfen gÃ¶nderen hesap seÃ§iniz.');
                return;
            }

            if (!selectedBank) {
                alert('LÃ¼tfen alÄ±cÄ± bankasÄ± seÃ§iniz.');
                return;
            }

            if (!recipientIBAN || recipientIBAN.length !== 26) {
                alert('LÃ¼tfen geÃ§erli bir IBAN giriniz (26 karakter).');
                return;
            }

            if (!amount || amount <= 0) {
                alert('LÃ¼tfen geÃ§erli bir tutar giriniz.');
                return;
            }

            const senderAccount = accounts.find(acc => acc.hesapID == senderID);
            const totalAmount = amount + currentFee;

            if (totalAmount > senderAccount.kullanilabilirBakiye) {
                alert(`Yetersiz bakiye!\n\nGÃ¶nderilecek: ${formatCurrency(amount, 'TL')}\nÄ°ÅŸlem Ãœcreti: ${formatCurrency(currentFee, 'TL')}\nToplam: ${formatCurrency(totalAmount, 'TL')}\n\nMevcut Bakiye: ${formatCurrency(senderAccount.kullanilabilirBakiye, 'TL')}`);
                return;
            }

            const recipientNameEl = document.getElementById('recipientNameDisplay');
            const recipientName = recipientNameEl ? recipientNameEl.textContent : '';

            if (!confirm(`EFT OnayÄ±\n\nGÃ¶nderen: ${formatIBAN(senderAccount.iban)}\nAlÄ±cÄ±: ${selectedBank.name}\nIBAN: ${formatIBAN(recipientIBAN)}\n${recipientName ? 'AlÄ±cÄ± AdÄ±: ' + recipientName + '\n' : ''}\nTutar: ${formatCurrency(amount, 'TL')}\nÃœcret: ${formatCurrency(currentFee, 'TL')}\nToplam: ${formatCurrency(totalAmount, 'TL')}\n\nOnaylÄ±yor musunuz?`)) {
                return;
            }

            try {
                const response = await apiPost('/islem/eft', {
                    kaynakHesapID: parseInt(senderID),
                    hedefIBAN: recipientIBAN,
                    aliciAdi: recipientName || selectedBank.name,
                    tutar: amount,
                    islemUcreti: currentFee,
                    aciklama: description || 'EFT Ä°ÅŸlemi',
                    paraBirimi: 'TL'
                });

                if (response.success) {
                    alert('EFT iÅŸleminiz baÅŸarÄ±yla gerÃ§ekleÅŸtirildi!\n\nÄ°ÅŸlem numaranÄ±z: ' + (response.data?.islemID || 'N/A'));
                    window.location.href = 'dashboard.html';
                } else {
                    alert('Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + (response.message || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error('Transfer error:', error);
                alert('Ä°ÅŸlem sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message);
            }
        }
    </script>
</body>

</html>