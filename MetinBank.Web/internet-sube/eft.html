<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetinBank - EFT</title>
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-logo">
                <img src="assets/images/logo.png" alt="MetinBank">
            </div>
            <nav class="header-nav">
                <a href="dashboard.html" class="nav-link">Ana Sayfa</a>
                <a href="hesaplar.html" class="nav-link">Hesaplarƒ±m</a>
                <div class="nav-dropdown">
                    <div class="nav-link nav-dropdown-toggle active">Para Transferi</div>
                    <div class="nav-dropdown-menu">
                        <a href="havale.html">Havale</a>
                        <a href="eft.html">EFT</a>
                        <a href="virman.html">Virman</a>
                    </div>
                </div>
                <a href="ekstre.html" class="nav-link">Ekstre</a>
                <a href="kartlar.html" class="nav-link">Kartlarƒ±m</a>
                <a href="kredi-basvuru.html" class="nav-link">Kredi Ba≈üvurusu</a>
                <a href="profil.html" class="nav-link">Profil</a>
                <a href="#" class="nav-link" onclick="logout(); return false;">√áƒ±kƒ±≈ü</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="transfer-container">
                <h1 style="margin-bottom: var(--spacing-xl);">EFT ƒ∞≈ülemi</h1>

                <!-- Two Column Layout -->
                <div class="transfer-grid">
                    <!-- Left Panel - Sender -->
                    <div class="transfer-panel">
                        <div class="panel-header">
                            <div class="panel-icon">üè¶</div>
                            <div class="panel-title">G√∂nderen Hesap</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Hesap Se√ßin</label>
                            <select class="form-select" id="senderAccount" onchange="updateSenderBalance()">
                                <option value="">Hesap se√ßiniz...</option>
                            </select>
                            <div class="selected-account" id="senderDetails" style="display: none;">
                                <div id="senderIBAN"></div>
                                <div class="account-balance">
                                    <span class="balance-label">Kullanƒ±labilir Bakiye:</span>
                                    <span class="balance-amount" id="senderBalance">0,00 TL</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Recipient -->
                    <div class="transfer-panel">
                        <div class="panel-header">
                            <div class="panel-icon">üèß</div>
                            <div class="panel-title">Alƒ±cƒ± Bilgileri</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Alƒ±cƒ± Bankasƒ±</label>
                            <select class="form-select" id="recipientBank">
                                <option value="">Banka se√ßiniz...</option>
                                <option value="Ziraat Bankasƒ±">Ziraat Bankasƒ±</option>
                                <option value="Vakƒ±fbank">Vakƒ±fbank</option>
                                <option value="Halkbank">Halkbank</option>
                                <option value="ƒ∞≈ü Bankasƒ±">ƒ∞≈ü Bankasƒ±</option>
                                <option value="Akbank">Akbank</option>
                                <option value="Garanti BBVA">Garanti BBVA</option>
                                <option value="Yapƒ± Kredi">Yapƒ± Kredi</option>
                                <option value="QNB Finansbank">QNB Finansbank</option>
                                <option value="DenizBank">DenizBank</option>
                                <option value="TEB">TEB</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Alƒ±cƒ± IBAN</label>
                            <input type="text" class="form-input" id="recipientIBAN"
                                placeholder="TR00 0000 0000 0000 0000 0000 00" maxlength="32"
                                oninput="formatIBANInput(this)">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Alƒ±cƒ± Adƒ±</label>
                            <input type="text" class="form-input" id="recipientName" placeholder="Alƒ±cƒ± adƒ± soyadƒ±">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tutar (TL)</label>
                            <input type="number" class="form-input" id="amount" placeholder="0,00" step="0.01" min="1">
                        </div>

                        <div class="form-group">
                            <label class="form-label">A√ßƒ±klama</label>
                            <input type="text" class="form-input" id="description"
                                placeholder="ƒ∞≈ülem a√ßƒ±klamasƒ± (isteƒüe baƒülƒ±)" maxlength="200">
                        </div>
                    </div>
                </div>

                <!-- Transfer Summary -->
                <div class="transfer-summary">
                    <h3 style="margin-bottom: var(--spacing-md);">ƒ∞≈ülem √ñzeti</h3>
                    <div class="summary-row">
                        <span>G√∂nderen:</span>
                        <span id="summaryFrom">-</span>
                    </div>
                    <div class="summary-row">
                        <span>Alƒ±cƒ± Banka:</span>
                        <span id="summaryBank">-</span>
                    </div>
                    <div class="summary-row">
                        <span>Alƒ±cƒ±:</span>
                        <span id="summaryTo">-</span>
                    </div>
                    <div class="summary-row">
                        <span>ƒ∞≈ülem √úcreti:</span>
                        <span>2,50 TL</span>
                    </div>
                    <div class="summary-row">
                        <span>Toplam:</span>
                        <span id="summaryTotal">0,00 TL</span>
                    </div>
                    <button class="btn btn-warning btn-lg"
                        style="width: 100%; margin-top: var(--spacing-md); color: white;" onclick="processTransfer()">
                        EFT G√∂nder
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        Copyright ¬© 2026 MetinBank - G√ºven, Birikim, Gelecek
    </footer>

    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/app.js"></script>
    <script>
        checkAuth();

        let accounts = [];
        const EFT_FEE = 2.50;

        window.addEventListener('DOMContentLoaded', async () => {
            await loadAccounts();
        });

        async function loadAccounts() {
            try {
                const user = getUser();
                const response = await apiGet(`/hesap/musteri/${user.musteriID}`);

                if (response.success && response.data) {
                    accounts = response.data;
                    const select = document.getElementById('senderAccount');

                    accounts.forEach(acc => {
                        const option = document.createElement('option');
                        option.value = acc.hesapID;
                        option.textContent = `${acc.hesapTipi} ${acc.hesapCinsi} - ${formatIBAN(acc.iban)}`;
                        option.dataset.iban = acc.iban;
                        option.dataset.balance = acc.kullanilabilirBakiye;
                        option.dataset.type = acc.hesapTipi;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
            }
        }

        function updateSenderBalance() {
            const select = document.getElementById('senderAccount');
            const option = select.options[select.selectedIndex];

            if (select.value) {
                document.getElementById('senderDetails').style.display = 'block';
                document.getElementById('senderIBAN').textContent = formatIBAN(option.dataset.iban);
                document.getElementById('senderBalance').textContent =
                    formatCurrency(parseFloat(option.dataset.balance), option.dataset.type);
                document.getElementById('summaryFrom').textContent = formatIBAN(option.dataset.iban);
            } else {
                document.getElementById('senderDetails').style.display = 'none';
                document.getElementById('summaryFrom').textContent = '-';
            }
            updateTotal();
        }

        function formatIBANInput(input) {
            let value = input.value.replace(/\s/g, '').toUpperCase();
            let formatted = '';
            for (let i = 0; i < value.length; i += 4) {
                if (i > 0) formatted += ' ';
                formatted += value.substring(i, i + 4);
            }
            input.value = formatted;
        }

        let currentFee = 0;

        async function calculateFee() {
            const amount = parseFloat(document.getElementById('amount').value);
            if (!amount || amount <= 0) {
                currentFee = 0;
                return;
            }

            try {
                const response = await apiGet(`/islemUcreti/hesapla?islemTipi=EFT&islemKanali=Internet&tutar=${amount}`);
                if (response.success && response.data) {
                    currentFee = response.data.ucret;
                }
            } catch (error) {
                console.error('Fee calculation error:', error);
                currentFee = 0;
            }
        }

        function updateTotal() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const total = amount + currentFee;
            const feeDisplay = document.querySelector('.summary-row:nth-child(4) span:last-child');
            if (feeDisplay) {
                feeDisplay.textContent = formatCurrency(currentFee, 'TL');
            }
            document.getElementById('summaryTotal').textContent = formatCurrency(total, 'TL');
        }

        document.getElementById('amount').addEventListener('input', async () => {
            await calculateFee();
            updateTotal();
        });
        document.getElementById('recipientBank').addEventListener('change', (e) => {
            document.getElementById('summaryBank').textContent = e.target.value || '-';
        });
        document.getElementById('recipientName').addEventListener('input', (e) => {
            document.getElementById('summaryTo').textContent = e.target.value || '-';
        });

        async function processTransfer() {
            const senderID = document.getElementById('senderAccount').value;
            const bank = document.getElementById('recipientBank').value;
            const recipientIBAN = document.getElementById('recipientIBAN').value.replace(/\s/g, '');
            const recipientName = document.getElementById('recipientName').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const description = document.getElementById('description').value;

            // Validation
            if (!senderID) {
                alert('L√ºtfen g√∂nderen hesap se√ßiniz.');
                return;
            }

            if (!bank) {
                alert('L√ºtfen alƒ±cƒ± bankasƒ± se√ßiniz.');
                return;
            }

            if (!recipientIBAN || recipientIBAN.length < 26) {
                alert('L√ºtfen ge√ßerli bir IBAN giriniz.');
                return;
            }

            if (!recipientName) {
                alert('L√ºtfen alƒ±cƒ± adƒ±nƒ± giriniz.');
                return;
            }

            if (!amount || amount <= 0) {
                alert('L√ºtfen ge√ßerli bir tutar giriniz.');
                return;
            }

            const senderAccount = accounts.find(acc => acc.hesapID == senderID);
            const totalAmount = amount + EFT_FEE;

            if (totalAmount > senderAccount.kullanilabilirBakiye) {
                alert(`Yetersiz bakiye! (ƒ∞≈ülem √ºcreti dahil: ${formatCurrency(totalAmount, 'TL')})`);
                return;
            }

            if (!confirm(`${formatCurrency(amount, 'TL')} + ${formatCurrency(EFT_FEE, 'TL')} √ºcret = ${formatCurrency(totalAmount, 'TL')} tutarƒ±nda EFT yapmak istediƒüinizden emin misiniz?`)) {
                return;
            }

            try {
                const response = await apiPost('/islem/eft', {
                    kaynakHesapID: parseInt(senderID),
                    hedefIBAN: recipientIBAN,
                    aliciBanka: bank,
                    aliciAdi: recipientName,
                    tutar: amount,
                    islemUcreti: EFT_FEE,
                    aciklama: description || 'EFT',
                    paraBirimi: 'TL'
                });

                if (response.success) {
                    alert('‚úì EFT i≈üleminiz ba≈üarƒ±yla ger√ßekle≈ütirildi!');
                    window.location.href = 'dashboard.html';
                } else {
                    alert('Hata: ' + (response.message || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z.'));
                }
            } catch (error) {
                console.error('Transfer error:', error);
                alert('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu.');
            }
        }
    </script>
</body>

</html>